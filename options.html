<!DOCTYPE html>
<html lang="en" class="dark">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Options Trading - SmartAirTrade</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            background-image: url('https://source.unsplash.com/random/1920x1080/?bitcoin,circuit');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            background-repeat: no-repeat;
        }

        body::before {
            content: '';
            position: fixed;
            inset: 0;
            z-index: -1;
        }

        html.light body::before {
            background-color: rgba(241, 245, 249, 0.85);
        }

        html.dark body::before {
            background-color: rgba(15, 23, 42, 0.85);
        }

        .glass {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(6px);
        }

        .dark .glass {
            background: rgba(17, 24, 39, 0.7);
        }

        .modal-bg {
            position: fixed;
            inset: 0;
            display: none;
            align-items: center;
            justify-content: center;
            background: rgba(2, 6, 23, 0.6);
            z-index: 60;
        }

        .modal-card {
            width: 360px;
            max-width: calc(100% - 32px);
        }

        ::-webkit-scrollbar {
            height: 8px;
            width: 8px;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(71, 85, 105, 0.6);
            border-radius: 6px;
        }
    </style>
</head>

<body class="text-slate-300">

    <!-- Header -->
    <header class="bg-slate-800/50 backdrop-blur-sm border-b border-slate-700 sticky top-0 z-50">
        <div class="max-w-[1920px] mx-auto px-4 sm:px-6 lg:px-8 flex items-center justify-between h-16">
            <span class="font-semibold text-lg tracking-tight text-sky-400">SmartAirTrade</span>
            <nav class="hidden md:flex items-center space-x-4">
                <a href="index.html" class="flex flex-col items-center justify-center text-slate-400 w-14 h-14">
                    <ion-icon name="home-outline" class="text-2xl"></ion-icon>
                    <span class="text-xs mt-1">Dashboard</span>
                </a>
                <a href="market.html" class="flex flex-col items-center justify-center text-slate-400  w-14 h-14">
                    <ion-icon name="trending-up-outline" class="text-2xl"></ion-icon>
                    <span class="text-xs mt-1">Market</span>
                </a>
                <a href="options.html" class="flex flex-col items-center justify-center text-sky-500 w-14 h-14">
                    <ion-icon name="options-outline" class="text-2xl text-sky-500"></ion-icon>
                    <span class="text-xs mt-1 text-sky-500">Options</span>
                </a>
                <a href="mining.html" class="flex flex-col items-center justify-center text-slate-400 w-14 h-14">
                    <ion-icon name="flame-outline" class="text-2xl"></ion-icon>
                    <span class="text-xs mt-1">Mining</span>
                </a>
            </nav>
            <div class="flex items-center space-x-2">
                <button id="profile-btn" class="px-3 py-2 rounded-md bg-slate-700 hover:bg-slate-600 flex items-center">
                    <ion-icon name="settings-outline" class="mr-1 text-white"></ion-icon> Profile
                </button>
            </div>
        </div>
    </header>

    <!-- Main -->
    <main class="max-w-[1200px] mx-auto p-4 sm:p-6 lg:p-8 pb-28">
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">

            <!-- Left: active/history table -->
            <section class="lg:col-span-8 flex flex-col gap-4">
                <div class="glass rounded-lg shadow p-4">
                    <div class="flex items-center justify-between">
                        <h2 class="text-xl font-bold text-slate-900 dark:text-white">Options Trading</h2>
                        <div class="text-sm text-slate-500">Server time: <span id="time-display">--:--:--</span></div>
                    </div>
                    <p class="text-sm text-slate-500 mt-2">Trade options with live crypto prices. Expire outcomes determined by real-time market data.</p>
                </div>

                <div class="glass rounded-lg shadow overflow-hidden flex flex-col">
                    <div class="flex border-b border-slate-200 dark:border-slate-700">
                        <button id="tab-active" class="px-4 py-3 text-sm font-semibold border-b-2 border-transparent">Active Positions (<span id="active-count">0</span>)</button>
                        <button id="tab-history" class="px-4 py-3 text-sm font-semibold border-b-2 border-transparent text-slate-500">Trade History</button>
                    </div>

                    <div class="grid grid-cols-3 sm:grid-cols-6 gap-2 text-xs text-slate-500 px-4 py-2 bg-slate-100/50 dark:bg-slate-800/50">
                        <div>Pair</div>
                        <div>Direction</div>
                        <div>Entry</div>
                        <div class="hidden sm:block">Close</div>
                        <div class="text-center">Status</div>
                        <div class="text-right">Payout</div>
                    </div>

                    <div id="trades-scroll" class="max-h-[360px] overflow-auto"></div>
                </div>
            </section>

            <!-- Right: chart + controls -->
            <aside class="lg:col-span-4 flex flex-col gap-4">
                <div class="glass rounded-lg shadow p-4">
                    <div class="flex items-center gap-3 mb-3">
                        <img id="pair-icon" src="" alt="" class="w-10 h-10 rounded-full" />
                        <div class="flex-1">
                            <div class="flex items-center gap-2">
                                <h3 id="pair-title" class="text-lg font-bold text-slate-900 dark:text-white">BTC / USD</h3>
                                <div id="price" class="font-mono text-slate-500">--</div>
                            </div>
                            <select id="pair-select" class="mt-2 w-full bg-slate-100 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-md py-2 px-3 text-slate-900 dark:text-white"></select>
                        </div>
                    </div>

                    <div id="chart" class="h-56 w-full rounded-md mb-3 border border-slate-200 dark:border-slate-700"></div>

                    <div class="grid grid-cols-2 gap-3">
                        <button id="buy-up" class="bg-green-600 hover:bg-green-700 text-white py-3 rounded-md flex items-center justify-center font-bold">Buy Rise</button>
                        <button id="buy-down" class="bg-red-600 hover:bg-red-700 text-white py-3 rounded-md flex items-center justify-center font-bold">Buy Low</button>
                    </div>
                </div>
            </aside>
        </div>
    </main>

    <!-- Trade Modal -->
    <div id="trade-modal" class="modal-bg">
        <div class="modal-card glass rounded-lg p-4">
            <div class="flex items-center justify-between mb-3">
                <h3 id="modal-title" class="text-lg font-semibold text-slate-900 dark:text-white">Execute Trade</h3>
                <button id="close-modal" class="text-slate-500 hover:text-slate-700">âœ•</button>
            </div>
            <div class="space-y-3">
                <div class="text-sm text-slate-500">Pair: <strong id="modal-pair">BTC/USD</strong></div>
                <div class="text-sm text-slate-500">Direction: <strong id="modal-dir">Rise</strong></div>
                <label class="text-xs text-slate-500">Amount (USD)</label>
                <input id="trade-amount" type="number" min="1" step="0.01" class="w-full rounded-md border border-slate-200 dark:border-slate-600 px-3 py-2 bg-white/90 dark:bg-slate-700 text-slate-900" />
                <label class="text-xs text-slate-500">Duration</label>
                <select id="trade-duration" class="w-full rounded-md border border-slate-200 dark:border-slate-600 px-3 py-2 bg-white/90 dark:bg-slate-700 text-slate-900">
                    <option value="30">30s</option>
                    <option value="60">60s</option>
                    <option value="90">90s</option>
                </select>
                <div id="trade-error" class="text-sm text-red-500 hidden"></div>
                <div class="flex gap-2">
                    <button id="confirm-trade" class="flex-1 bg-sky-500 hover:bg-sky-600 text-white py-2 rounded-md font-bold">Confirm</button>
                    <button id="cancel-trade" class="flex-1 bg-slate-200 hover:bg-slate-300 text-slate-800 py-2 rounded-md">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Mobile Footer Navigation -->
  <nav class="md:hidden fixed bottom-0 left-0 right-0 bg-slate-800/80 backdrop-blur-sm border-t border-slate-700 flex justify-around py-2 z-50">
    <a href="index.html" class="flex flex-col items-center text-slate-500">
      <ion-icon name="home-outline" class="text-2xl"></ion-icon>
      <span class="text-xs mt-1">Dashboard</span>
    </a>
    <a href="market.html" class="flex flex-col items-center text-slate-400">
      <ion-icon name="trending-up-outline" class="text-2xl"></ion-icon>
      <span class="text-xs mt-1">Market</span>
    </a>
    <a href="options.html" class="flex flex-col items-center text-sky-400">
      <ion-icon name="options-outline" class="text-2xl"></ion-icon>
      <span class="text-xs mt-1">Options</span>
    </a>
    <a href="mining.html" class="flex flex-col items-center text-slate-400">
      <ion-icon name="flame-outline" class="text-2xl"></ion-icon>
      <span class="text-xs mt-1">Mining</span>
    </a>
  </nav>

    <!-- Toast -->
    <div id="toast" class="fixed bottom-6 right-6 bg-slate-900 text-white py-2 px-3 rounded hidden z-50"></div>

    <script type="module" src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.esm.js"></script>
    <script nomodule src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.js"></script>

    <!-- Lightweight Charts -->
    <script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>

    <script>
        document.getElementById('profile-btn').addEventListener('click', () => {
      window.location.href = 'profile.html';
    });
        const OPTIONS_CONFIG = {30:{duration:30,profit:30,minAmount:50},60:{duration:60,profit:60,minAmount:10000},90:{duration:90,profit:90,minAmount:20000}};
        const PAIRS = [
            {id:'bitcoin',symbol:'BTC',vs:'USD',iconId:1},
            {id:'ethereum',symbol:'ETH',vs:'USD',iconId:279},
            {id:'solana',symbol:'SOL',vs:'USD',iconId:403}
        ];
        let selectedPair = PAIRS[0];

        const pairSelect = document.getElementById('pair-select');
        const pairTitle = document.getElementById('pair-title');
        const pairIcon = document.getElementById('pair-icon');
        const priceDisplay = document.getElementById('price');
        const tradeModalBg = document.getElementById('trade-modal');
        const modalPair = document.getElementById('modal-pair');
        const modalDir = document.getElementById('modal-dir');
        const tradeAmountInput = document.getElementById('trade-amount');
        const tradeDurationSelect = document.getElementById('trade-duration');
        const tradeError = document.getElementById('trade-error');
        const confirmBtn = document.getElementById('confirm-trade');
        const cancelBtn = document.getElementById('cancel-trade');
        const closeModalBtn = document.getElementById('close-modal');
        const toastEl = document.getElementById('toast');
        const tradesScroll = document.getElementById('trades-scroll');
        const activeCountEl = document.getElementById('active-count');
        const timeDisplay = document.getElementById('time-display');

        let chart, candleSeries;
        let activeTrades = [];
        let tradeHistory = [];
        let currentTab = 'active';
        let pendingDirection = null;

        function showToast(msg){toastEl.textContent=msg;toastEl.classList.remove('hidden');setTimeout(()=>toastEl.classList.add('hidden'),2000);}
        function formatPrice(n){return n>=1000?'$'+Number(n).toLocaleString(undefined,{maximumFractionDigits:2}):'$'+Number(n).toFixed(2);}
        function formatTime(ms){if(ms<=0)return'00:00';const s=Math.floor(ms/1000);const m=Math.floor(s/60).toString().padStart(2,'0');const sec=(s%60).toString().padStart(2,'0');return`${m}:${sec}`;}

        async function fetchOHLC(coinId){
            try{
                const resp=await fetch(`https://api.coingecko.com/api/v3/coins/${coinId}/ohlc?vs_currency=usd&days=1`);
                const data=await resp.json();
                return data.map(d=>({time:d[0]/1000,open:d[1],high:d[2],low:d[3],close:d[4]}));
            }catch(e){console.error(e);return[];}
        }

        async function fetchCurrentPrice(coinId){
            try{
                const resp=await fetch(`https://api.coingecko.com/api/v3/simple/price?ids=${coinId}&vs_currencies=usd`);
                const data=await resp.json();
                return data[coinId].usd;
            }catch(e){console.error(e);return 0;}
        }

        async function updateSelectedPair(coinId){
            selectedPair = PAIRS.find(p=>p.id===coinId);
            pairTitle.textContent=`${selectedPair.symbol}/${selectedPair.vs}`;
            pairIcon.src=`https://assets.coingecko.com/coins/images/${selectedPair.iconId}/small.png`;
            const ohlcData = await fetchOHLC(coinId);
            const price = await fetchCurrentPrice(coinId);
            priceDisplay.textContent = formatPrice(price);

            if(!chart){
                chart = LightweightCharts.createChart(document.getElementById('chart'), {
                    layout: { backgroundColor: '#111827', textColor: '#d1d5db' },
                    rightPriceScale: { borderColor: '#555' },
                    timeScale: { borderColor: '#555' },
                });
                candleSeries = chart.addCandlestickSeries();
            }

            candleSeries.setData(ohlcData);
        }

        function initPairs(){
            pairSelect.innerHTML = PAIRS.map(p=>`<option value="${p.id}">${p.symbol}/${p.vs}</option>`).join('');
            updateSelectedPair(selectedPair.id);
        }

        pairSelect.addEventListener('change', e => updateSelectedPair(e.target.value));

        document.getElementById('buy-up').addEventListener('click', ()=>openTradeModal('higher'));
        document.getElementById('buy-down').addEventListener('click', ()=>openTradeModal('lower'));

        function openTradeModal(direction){
            pendingDirection = direction;
            tradeModalBg.style.display = 'flex';
            modalPair.textContent = `${selectedPair.symbol}/${selectedPair.vs}`;
            modalDir.textContent = direction==='higher'?'Rise':'Low';
            tradeAmountInput.value='';
            tradeDurationSelect.value='30';
            tradeError.classList.add('hidden'); tradeError.textContent='';
        }

        function closeTradeModal(){pendingDirection=null; tradeModalBg.style.display='none'; tradeError.classList.add('hidden'); tradeError.textContent='';}
        cancelBtn.addEventListener('click',closeTradeModal);
        closeModalBtn.addEventListener('click',closeTradeModal);
        document.addEventListener('keydown', e=>{if(e.key==='Escape') closeTradeModal();});

        confirmBtn.addEventListener('click', ()=>{
            const amount=parseFloat(tradeAmountInput.value);
            const duration=parseInt(tradeDurationSelect.value,10);
            const cfg=OPTIONS_CONFIG[duration];
            if(isNaN(amount)||amount<=0){tradeError.textContent='Enter a valid amount'; tradeError.classList.remove('hidden'); return;}
            if(amount<cfg.minAmount){tradeError.textContent=`Minimum amount for ${duration}s is $${cfg.minAmount.toLocaleString()}`; tradeError.classList.remove('hidden'); return;}
            const entryPrice=parseFloat(priceDisplay.textContent.replace(/[^0-9.-]+/g,""));
            const payout=+(amount*(1+cfg.profit/100)).toFixed(2);
            const id='T'+Math.random().toString(36).slice(2,9);
            const trade={id,pairId:selectedPair.id,pair:`${selectedPair.symbol}/${selectedPair.vs}`,direction:pendingDirection,entryPrice,amount,payout,expiryTime:Date.now()+cfg.duration*1000,status:'active',closePrice:null};
            activeTrades.push(trade); showToast(`Trade placed: ${trade.pair} ${trade.direction} $${trade.amount} (${duration}s)`); renderTrades(); closeTradeModal();
        });

        // Tabs
        document.getElementById('tab-active').addEventListener('click', ()=>{currentTab='active'; renderTrades();});
        document.getElementById('tab-history').addEventListener('click', ()=>{currentTab='history'; renderTrades();});

        function tradeRowDom(trade){
            const row=document.createElement('div');
            row.className='grid grid-cols-3 sm:grid-cols-6 gap-2 items-center text-xs sm:text-sm py-3 px-4 border-b border-slate-200 dark:border-slate-700/50';
            const isWin=trade.status==='win',isLoss=trade.status==='loss',isActive=trade.status==='active';
            row.innerHTML=`
                <div class="font-semibold text-slate-900 dark:text-white">${trade.pair}</div>
                <div class="font-semibold capitalize ${trade.direction==='higher'?'text-green-500 dark:text-green-400':'text-red-500 dark:text-red-400'}">${trade.direction}</div>
                <div class="font-mono text-slate-600 dark:text-slate-300">${trade.entryPrice.toFixed(2)}</div>
                <div class="font-mono text-slate-600 dark:text-slate-300 hidden sm:block">${trade.closePrice?trade.closePrice.toFixed(2):'---'}</div>
                <div class="font-semibold text-center ${isWin?'text-green-500 dark:text-green-400':isLoss?'text-red-500 dark:text-red-400':'text-sky-500 dark:text-sky-400'}">
                    ${isActive?formatTime(trade.expiryTime-Date.now()):(trade.status||'')}
                </div>
                <div class="font-mono text-right">${isWin?('+'+(trade.payout-trade.amount).toFixed(2)):isLoss?('-'+trade.amount.toFixed(2)):trade.payout.toFixed(2)}</div>`;
            return row;
        }

        function renderTrades(){
            tradesScroll.innerHTML='';
            const list = currentTab==='active'? activeTrades: tradeHistory;
            list.forEach(tr=>tradesScroll.appendChild(tradeRowDom(tr)));
            activeCountEl.textContent=String(activeTrades.length);
        }

        function checkExpiries(){
            const now=Date.now();
            const currentPrice=parseFloat(priceDisplay.textContent.replace(/[^0-9.-]+/g,""));
            const expired=activeTrades.filter(t=>now>=t.expiryTime);
            expired.forEach(tr=>{
                const isWin=(tr.direction==='higher'&&currentPrice>tr.entryPrice)||(tr.direction==='lower'&&currentPrice<tr.entryPrice);
                tr.status=isWin?'win':'loss';
                tr.closePrice=currentPrice;
                tradeHistory.unshift(tr);
            });
            activeTrades=activeTrades.filter(t=>now<tr.expiryTime);
            renderTrades();
        }

        setInterval(()=>{checkExpiries(); timeDisplay.textContent=new Date().toLocaleTimeString();},1000);

        initPairs();
        setInterval(()=>updateSelectedPair(selectedPair.id),30000); // refresh price every 30s
    </script>

</body>
</html>
